<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
      min-height: 100vh;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }
    
    .login-box {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    
    .login-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--gray-700);
    }
    
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .error-message {
      color: var(--danger);
      font-size: 0.875rem;
      text-align: center;
      margin-top: 1rem;
    }
    
    /* Dashboard Styles */
    .dashboard {
      display: none;
      min-height: 100vh;
    }
    
    .dashboard.active {
      display: block;
    }
    
    .header {
      background: white;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .range-select {
      padding: 0.5rem 1rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      background: white;
      cursor: pointer;
    }
    
    .date-picker-container {
      display: none;
      align-items: center;
      gap: 0.5rem;
    }
    
    .date-picker-container.active {
      display: flex;
    }
    
    .date-input {
      padding: 0.5rem;
      border: 1px solid var(--gray-300);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      background: white;
    }
    
    .date-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .date-label {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    
    .btn-apply {
      background: var(--primary);
      color: white;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }
    
    .btn-apply:hover {
      background: var(--primary-dark);
    }
    
    .btn-refresh {
      background: var(--gray-100);
      color: var(--gray-700);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    .btn-refresh:hover {
      background: var(--gray-200);
    }
    
    .btn-logout {
      background: transparent;
      color: var(--gray-500);
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    
    .btn-logout:hover {
      color: var(--danger);
    }
    
    .main-content {
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Metric Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .metric-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .metric-label {
      font-size: 0.875rem;
      color: var(--gray-500);
      margin-bottom: 0.5rem;
    }
    
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .metric-value.success { color: var(--success); }
    .metric-value.warning { color: var(--warning); }
    .metric-value.danger { color: var(--danger); }
    
    .metric-change {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.25rem;
    }
    
    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    
    @media (min-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .chart-full {
        grid-column: 1 / -1;
      }
    }
    
    .chart-card {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
    }
    
    .chart-container.tall {
      height: 400px;
    }
    
    /* Funnel Table */
    .funnel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .funnel-table th,
    .funnel-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .funnel-table th {
      font-weight: 600;
      color: var(--gray-500);
      background: var(--gray-50);
    }
    
    .funnel-table tr:hover {
      background: var(--gray-50);
    }
    
    .step-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      min-width: 100px;
    }
    
    .step-bar-fill {
      height: 100%;
      background: var(--primary);
      transition: width 0.3s;
    }
    
    .abandon-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .abandon-low { background: #d1fae5; color: #065f46; }
    .abandon-medium { background: #fef3c7; color: #92400e; }
    .abandon-high { background: #fee2e2; color: #991b1b; }
    
    /* Answer Cards */
    .answers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .answer-card {
      background: var(--gray-50);
      padding: 1rem;
      border-radius: 0.5rem;
    }
    
    .answer-question {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      color: var(--gray-700);
    }
    
    .answer-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--gray-200);
    }
    
    .answer-option:last-child {
      border-bottom: none;
    }
    
    .answer-text {
      font-size: 0.8rem;
      color: var(--gray-700);
      max-width: 60%;
      word-break: break-word;
    }
    
    .answer-stats {
      text-align: right;
    }
    
    .answer-count {
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .answer-percent {
      font-size: 0.75rem;
      color: var(--gray-500);
    }
    
    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .header {
        padding: 1rem;
      }
      
      .header-controls {
        width: 100%;
        justify-content: flex-start;
      }
      
      .date-picker-container {
        flex-wrap: wrap;
        width: 100%;
      }
      
      .date-picker-container.active {
        display: flex;
      }
      
      .date-input {
        flex: 1;
        min-width: 120px;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .metric-value {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
    <div class="login-box">
      <h1 class="login-title">Quiz Analytics Dashboard</h1>
      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="password">Senha</label>
          <input type="password" id="password" class="form-input" placeholder="Digite a senha" required>
        </div>
        <button type="submit" class="btn btn-primary">Entrar</button>
        <p id="login-error" class="error-message" style="display: none;"></p>
      </form>
    </div>
  </div>
  
  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <header class="header">
      <h1 class="header-title">Quiz Analytics Dashboard</h1>
      <div class="header-controls">
        <select id="range-select" class="range-select">
          <option value="today">Hoje</option>
          <option value="yesterday">Ontem</option>
          <option value="7d" selected>Ultimos 7 dias</option>
          <option value="30d">Ultimos 30 dias</option>
          <option value="custom">Personalizado</option>
        </select>
        <div id="date-picker-container" class="date-picker-container">
          <span class="date-label">De:</span>
          <input type="date" id="start-date" class="date-input">
          <span class="date-label">Ate:</span>
          <input type="date" id="end-date" class="date-input">
          <button id="btn-apply-dates" class="btn btn-apply">Aplicar</button>
        </div>
        <button id="btn-refresh" class="btn btn-refresh">Atualizar</button>
        <button id="btn-logout" class="btn btn-logout">Sair</button>
      </div>
    </header>
    
    <main class="main-content">
      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
      </div>
      
      <!-- Dashboard Content -->
      <div id="dashboard-content" style="display: none;">
        <!-- Metrics Cards -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Total de Sessoes</div>
            <div id="metric-sessions" class="metric-value">-</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Total de Visualizacoes</div>
            <div id="metric-views" class="metric-value">-</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Checkouts</div>
            <div id="metric-checkouts" class="metric-value success">-</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Taxa de Conversao</div>
            <div id="metric-conversion" class="metric-value">-</div>
            <div class="metric-change">Baseado em sessoes</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Conclusao do Quiz</div>
            <div id="metric-completion" class="metric-value">-</div>
            <div class="metric-change">Baseado em sessoes</div>
          </div>
        </div>
        
        <!-- Sales Metrics Cards -->
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--gray-700);">Vendas (Hotmart)</h2>
        <div class="metrics-grid" style="margin-bottom: 2rem;">
          <div class="metric-card" style="border-left: 4px solid var(--success);">
            <div class="metric-label">Vendas Aprovadas</div>
            <div id="metric-sales-approved" class="metric-value success">-</div>
          </div>
          <div class="metric-card" style="border-left: 4px solid var(--primary);">
            <div class="metric-label">Receita Total</div>
            <div id="metric-revenue" class="metric-value">-</div>
            <div class="metric-change">Somente aprovadas</div>
          </div>
          <div class="metric-card" style="border-left: 4px solid var(--warning);">
            <div class="metric-label">Ticket Medio</div>
            <div id="metric-ticket" class="metric-value">-</div>
          </div>
          <div class="metric-card" style="border-left: 4px solid var(--danger);">
            <div class="metric-label">Taxa de Reembolso</div>
            <div id="metric-refund" class="metric-value">-</div>
            <div id="metric-refund-count" class="metric-change">0 reembolsos</div>
          </div>
          <div class="metric-card" style="border-left: 4px solid var(--success);">
            <div class="metric-label">Conv. Real (Vendas/Sessoes)</div>
            <div id="metric-real-conversion" class="metric-value">-</div>
            <div class="metric-change">Vendas aprovadas / Sessoes</div>
          </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
          <!-- Funnel Chart -->
          <div class="chart-card chart-full">
            <h3 class="chart-title">Funil de Conversao por Etapa</h3>
            <div class="chart-container tall">
              <canvas id="funnel-chart"></canvas>
            </div>
          </div>
          
          <!-- Funnel Table -->
          <div class="chart-card chart-full">
            <h3 class="chart-title">Detalhes de Abandono por Etapa</h3>
            <div style="overflow-x: auto;">
              <table class="funnel-table">
                <thead>
                  <tr>
                    <th>Etapa</th>
                    <th>Nome</th>
                    <th>Visualizacoes</th>
                    <th>Abandonos</th>
                    <th>Taxa de Abandono</th>
                    <th>Progresso</th>
                  </tr>
                </thead>
                <tbody id="funnel-table-body">
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Abandonment Rate Chart -->
          <div class="chart-card">
            <h3 class="chart-title">Taxa de Abandono por Etapa</h3>
            <div class="chart-container">
              <canvas id="abandonment-chart"></canvas>
            </div>
          </div>
          
          <!-- Conversion Pie Chart -->
          <div class="chart-card">
            <h3 class="chart-title">Distribuicao de Conversao</h3>
            <div class="chart-container">
              <canvas id="conversion-chart"></canvas>
            </div>
          </div>
          
          <!-- Sales by Source Table -->
          <div class="chart-card">
            <h3 class="chart-title">Vendas por Fonte de Trafego</h3>
            <div style="overflow-x: auto; max-height: 300px;">
              <table class="funnel-table" id="sales-by-source-table">
                <thead>
                  <tr>
                    <th>Fonte (utm_source)</th>
                    <th>Vendas</th>
                    <th>Aprovadas</th>
                    <th>Receita</th>
                  </tr>
                </thead>
                <tbody id="sales-source-body">
                  <tr><td colspan="4" style="text-align: center; color: var(--gray-500);">Nenhuma venda registrada</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Sales Chart -->
          <div class="chart-card">
            <h3 class="chart-title">Distribuicao de Vendas</h3>
            <div class="chart-container">
              <canvas id="sales-chart"></canvas>
            </div>
          </div>
          
          <!-- Answer Distributions -->
          <div class="chart-card chart-full">
            <h3 class="chart-title">Respostas Mais Escolhidas por Pergunta</h3>
            <div id="answers-container" class="answers-grid">
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // State
    let authToken = localStorage.getItem('dashboard_auth');
    let currentRange = '7d';
    let customStartDate = null;
    let customEndDate = null;
    let charts = {};
    
    // DOM Elements
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const loading = document.getElementById('loading');
    const dashboardContent = document.getElementById('dashboard-content');
    const rangeSelect = document.getElementById('range-select');
    const datePickerContainer = document.getElementById('date-picker-container');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set default dates for custom picker (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      endDateInput.value = formatDateForInput(today);
      startDateInput.value = formatDateForInput(thirtyDaysAgo);
      endDateInput.max = formatDateForInput(today);
      
      if (authToken) {
        showDashboard();
      }
      
      // Event listeners
      loginForm.addEventListener('submit', handleLogin);
      rangeSelect.addEventListener('change', handleRangeChange);
      document.getElementById('btn-refresh').addEventListener('click', loadAnalytics);
      document.getElementById('btn-logout').addEventListener('click', handleLogout);
      document.getElementById('btn-apply-dates').addEventListener('click', handleApplyCustomDates);
    });
    
    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }
    
    async function handleLogin(e) {
      e.preventDefault();
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('/api/analytics?range=24h', {
          headers: { 'Authorization': `Bearer ${password}` }
        });
        
        if (response.ok) {
          authToken = password;
          localStorage.setItem('dashboard_auth', password);
          loginError.style.display = 'none';
          showDashboard();
        } else {
          loginError.textContent = 'Senha incorreta';
          loginError.style.display = 'block';
        }
      } catch (error) {
        loginError.textContent = 'Erro ao conectar. Verifique a configuracao.';
        loginError.style.display = 'block';
      }
    }
    
    function handleLogout() {
      authToken = null;
      localStorage.removeItem('dashboard_auth');
      loginScreen.style.display = 'flex';
      dashboard.classList.remove('active');
    }
    
    function showDashboard() {
      loginScreen.style.display = 'none';
      dashboard.classList.add('active');
      loadAnalytics();
    }
    
    function handleRangeChange(e) {
      currentRange = e.target.value;
      
      // Show/hide custom date picker
      if (currentRange === 'custom') {
        datePickerContainer.classList.add('active');
        // Don't load analytics yet - wait for user to click Apply
      } else {
        datePickerContainer.classList.remove('active');
        customStartDate = null;
        customEndDate = null;
        loadAnalytics();
      }
    }
    
    function handleApplyCustomDates() {
      const startVal = startDateInput.value;
      const endVal = endDateInput.value;
      
      if (!startVal || !endVal) {
        alert('Por favor, selecione as datas de inicio e fim.');
        return;
      }
      
      const start = new Date(startVal);
      const end = new Date(endVal);
      
      if (start > end) {
        alert('A data de inicio deve ser anterior a data de fim.');
        return;
      }
      
      customStartDate = startVal;
      customEndDate = endVal;
      loadAnalytics();
    }
    
    async function loadAnalytics() {
      loading.style.display = 'flex';
      dashboardContent.style.display = 'none';
      
      try {
        let url = `/api/analytics?range=${currentRange}`;
        
        // Add custom date parameters if custom range is selected
        if (currentRange === 'custom' && customStartDate && customEndDate) {
          url += `&start_date=${customStartDate}&end_date=${customEndDate}`;
        }
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            handleLogout();
            return;
          }
          throw new Error('Failed to load analytics');
        }
        
        const data = await response.json();
        renderDashboard(data);
        
        loading.style.display = 'none';
        dashboardContent.style.display = 'block';
      } catch (error) {
        console.error('Error loading analytics:', error);
        loading.innerHTML = '<p style="color: var(--danger);">Erro ao carregar dados. Verifique as configuracoes do Supabase.</p>';
      }
    }
    
    function renderDashboard(data) {
      // Update metrics
      const conversion = data.conversion || {};
      document.getElementById('metric-sessions').textContent = formatNumber(conversion.total_sessions || 0);
      document.getElementById('metric-views').textContent = formatNumber(conversion.total_views || 0);
      document.getElementById('metric-checkouts').textContent = formatNumber(conversion.total_checkouts || 0);
      document.getElementById('metric-conversion').textContent = `${conversion.conversion_rate || 0}%`;
      document.getElementById('metric-completion').textContent = `${conversion.quiz_completion_rate || 0}%`;
      
      // Color coding for conversion rate
      const convRate = parseFloat(conversion.conversion_rate) || 0;
      const convEl = document.getElementById('metric-conversion');
      convEl.className = 'metric-value ' + (convRate >= 5 ? 'success' : convRate >= 2 ? 'warning' : 'danger');
      
      // Color coding for completion rate
      const compRate = parseFloat(conversion.quiz_completion_rate) || 0;
      const compEl = document.getElementById('metric-completion');
      compEl.className = 'metric-value ' + (compRate >= 50 ? 'success' : compRate >= 25 ? 'warning' : 'danger');
      
      // Render funnel chart
      renderFunnelChart(data.funnel || []);
      
      // Render funnel table
      renderFunnelTable(data.funnel || []);
      
      // Render abandonment chart
      renderAbandonmentChart(data.funnel || []);
      
      // Render conversion pie chart
      renderConversionChart(conversion);
      
      // Render sales metrics
      renderSalesMetrics(data.sales || {}, conversion);
      
      // Render sales by source
      renderSalesBySource(data.sales_by_source || []);
      
      // Render sales chart
      renderSalesChart(data.sales || {});
      
      // Render answers
      renderAnswers(data.answers || []);
    }
    
    function renderSalesMetrics(sales, conversion) {
      const approved = parseInt(sales.approved_sales) || 0;
      const refunded = parseInt(sales.refunded_sales) || 0;
      const revenueCents = parseInt(sales.total_revenue_cents) || 0;
      const ticketCents = parseInt(sales.avg_ticket_cents) || 0;
      const refundRate = parseFloat(sales.refund_rate) || 0;
      const totalSessions = parseInt(conversion.total_sessions) || 0;
      
      document.getElementById('metric-sales-approved').textContent = formatNumber(approved);
      document.getElementById('metric-revenue').textContent = formatCurrency(revenueCents);
      document.getElementById('metric-ticket').textContent = formatCurrency(ticketCents);
      document.getElementById('metric-refund').textContent = `${refundRate}%`;
      document.getElementById('metric-refund-count').textContent = `${refunded} reembolso(s)`;
      
      const realConvRate = totalSessions > 0 ? ((approved / totalSessions) * 100).toFixed(2) : 0;
      const realConvEl = document.getElementById('metric-real-conversion');
      realConvEl.textContent = `${realConvRate}%`;
      realConvEl.className = 'metric-value ' + (parseFloat(realConvRate) >= 2 ? 'success' : parseFloat(realConvRate) >= 1 ? 'warning' : 'danger');
      
      const refundEl = document.getElementById('metric-refund');
      refundEl.className = 'metric-value ' + (refundRate <= 5 ? 'success' : refundRate <= 10 ? 'warning' : 'danger');
    }
    
    function renderSalesBySource(salesBySource) {
      const tbody = document.getElementById('sales-source-body');
      
      if (!salesBySource || salesBySource.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--gray-500);">Nenhuma venda registrada</td></tr>';
        return;
      }
      
      tbody.innerHTML = salesBySource.map(s => {
        const revenueCents = parseInt(s.total_revenue_cents) || 0;
        return `
          <tr>
            <td><strong>${s.source || 'direto'}</strong></td>
            <td>${formatNumber(s.total_sales || 0)}</td>
            <td>${formatNumber(s.approved_sales || 0)}</td>
            <td>${formatCurrency(revenueCents)}</td>
          </tr>
        `;
      }).join('');
    }
    
    function renderSalesChart(sales) {
      const ctx = document.getElementById('sales-chart').getContext('2d');
      
      if (charts.sales) {
        charts.sales.destroy();
      }
      
      const approved = parseInt(sales.approved_sales) || 0;
      const refunded = parseInt(sales.refunded_sales) || 0;
      const pending = (parseInt(sales.total_sales) || 0) - approved - refunded;
      
      charts.sales = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Aprovadas', 'Reembolsadas', 'Pendentes/Outras'],
          datasets: [{
            data: [approved, refunded, Math.max(0, pending)],
            backgroundColor: [
              'rgba(16, 185, 129, 0.8)',
              'rgba(239, 68, 68, 0.8)',
              'rgba(245, 158, 11, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function formatCurrency(cents) {
      const value = cents / 100;
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }
    
    function renderFunnelChart(funnel) {
      const ctx = document.getElementById('funnel-chart').getContext('2d');
      
      if (charts.funnel) {
        charts.funnel.destroy();
      }
      
      const labels = funnel.map(f => `${f.step_index}: ${truncate(f.step_name, 15)}`);
      const views = funnel.map(f => parseInt(f.total_views) || 0);
      const abandons = funnel.map(f => parseInt(f.total_abandons) || 0);
      
      charts.funnel = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Visualizacoes',
              data: views,
              backgroundColor: 'rgba(37, 99, 235, 0.8)',
              borderRadius: 4
            },
            {
              label: 'Abandonos',
              data: abandons,
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: { size: 10 }
              }
            },
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              position: 'top'
            }
          }
        }
      });
    }
    
    function renderFunnelTable(funnel) {
      const tbody = document.getElementById('funnel-table-body');
      const maxViews = Math.max(...funnel.map(f => parseInt(f.total_views) || 1));
      
      tbody.innerHTML = funnel.map(f => {
        const views = parseInt(f.total_views) || 0;
        const abandons = parseInt(f.total_abandons) || 0;
        const rate = parseFloat(f.abandonment_rate) || 0;
        const progress = (views / maxViews) * 100;
        
        let badgeClass = 'abandon-low';
        if (rate >= 30) badgeClass = 'abandon-high';
        else if (rate >= 15) badgeClass = 'abandon-medium';
        
        return `
          <tr>
            <td><strong>${f.step_index}</strong></td>
            <td>${f.step_name}</td>
            <td>${formatNumber(views)}</td>
            <td>${formatNumber(abandons)}</td>
            <td><span class="abandon-badge ${badgeClass}">${rate}%</span></td>
            <td>
              <div class="step-bar">
                <div class="step-bar-fill" style="width: ${progress}%"></div>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderAbandonmentChart(funnel) {
      const ctx = document.getElementById('abandonment-chart').getContext('2d');
      
      if (charts.abandonment) {
        charts.abandonment.destroy();
      }
      
      const labels = funnel.map(f => f.step_index.toString());
      const rates = funnel.map(f => parseFloat(f.abandonment_rate) || 0);
      
      const colors = rates.map(r => {
        if (r >= 30) return 'rgba(239, 68, 68, 0.8)';
        if (r >= 15) return 'rgba(245, 158, 11, 0.8)';
        return 'rgba(16, 185, 129, 0.8)';
      });
      
      charts.abandonment = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Taxa de Abandono (%)',
            data: rates,
            backgroundColor: colors,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    function renderConversionChart(conversion) {
      const ctx = document.getElementById('conversion-chart').getContext('2d');
      
      if (charts.conversion) {
        charts.conversion.destroy();
      }
      
      const total = parseInt(conversion.total_sessions) || 0;
      const checkouts = parseInt(conversion.total_checkouts) || 0;
      const abandoned = total - checkouts;
      
      charts.conversion = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Converteram', 'Nao Converteram'],
          datasets: [{
            data: [checkouts, Math.max(0, abandoned)],
            backgroundColor: [
              'rgba(16, 185, 129, 0.8)',
              'rgba(229, 231, 235, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
    
    function renderAnswers(answers) {
      const container = document.getElementById('answers-container');
      
      // Group by question
      const grouped = {};
      answers.forEach(a => {
        if (!grouped[a.question_key]) {
          grouped[a.question_key] = [];
        }
        grouped[a.question_key].push(a);
      });
      
      // Sort each question's answers by count
      Object.keys(grouped).forEach(key => {
        grouped[key].sort((a, b) => b.answer_count - a.answer_count);
      });
      
      // Render cards
      container.innerHTML = Object.entries(grouped).map(([question, options]) => {
        const optionsHtml = options.slice(0, 5).map(opt => `
          <div class="answer-option">
            <span class="answer-text">${truncate(opt.answer_value, 30)}</span>
            <div class="answer-stats">
              <div class="answer-count">${formatNumber(opt.answer_count)}</div>
              <div class="answer-percent">${opt.percentage}%</div>
            </div>
          </div>
        `).join('');
        
        return `
          <div class="answer-card">
            <div class="answer-question">${formatQuestionKey(question)}</div>
            ${optionsHtml}
          </div>
        `;
      }).join('');
      
      if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<p style="color: var(--gray-500); padding: 2rem; text-align: center;">Nenhuma resposta registrada ainda.</p>';
      }
    }
    
    // Helpers
    function formatNumber(num) {
      return new Intl.NumberFormat('pt-BR').format(num);
    }
    
    function truncate(str, length) {
      if (!str) return '';
      return str.length > length ? str.substring(0, length) + '...' : str;
    }
    
    function formatQuestionKey(key) {
      const names = {
        'weight_goal': 'Objetivo de Peso',
        'body_type': 'Tipo de Corpo',
        'target_area': 'Area Alvo',
        'appearance_satisfaction': 'Satisfacao com Aparencia',
        'obstacles': 'Obstaculos',
        'daily_impact': 'Impacto na Vida',
        'desired_benefits': 'Beneficios Desejados',
        'water_intake': 'Consumo de Agua',
        'altura': 'Altura',
        'peso': 'Peso Atual',
        'peso_objetivo': 'Peso Objetivo'
      };
      return names[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
  </script>
</body>
</html>
